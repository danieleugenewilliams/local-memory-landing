# AWS Setup for Secure Downloads

## 1. Create S3 Bucket

```bash
# Create the S3 bucket for downloads
aws s3 mb s3://localmemory-secure-downloads --region us-east-1

# Enable versioning for the bucket
aws s3api put-bucket-versioning \
  --bucket localmemory-secure-downloads \
  --versioning-configuration Status=Enabled

# Set bucket policy for CloudFront access
aws s3api put-bucket-policy \
  --bucket localmemory-secure-downloads \
  --policy '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "CloudFrontAccess",
        "Effect": "Allow",
        "Principal": {
          "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity"
        },
        "Action": "s3:GetObject",
        "Resource": "arn:aws:s3:::localmemory-secure-downloads/*"
      }
    ]
  }'
```

## 2. Folder Structure

The S3 bucket will use this folder structure to match our secure URLs:

```
localmemory-secure-downloads/
├── downloads/
│   ├── 20318/                    # Time window (changes every ~12 hours)
│   │   ├── hash1/                # Unique hash for each platform
│   │   │   ├── macos/
│   │   │   │   └── local-memory-macos
│   │   │   ├── windows/
│   │   │   │   └── local-memory-windows.exe
│   │   │   └── linux/
│   │   │       └── local-memory-linux
│   │   └── hash2/
│   │       └── ...
│   ├── 20319/                    # Next time window
│   │   └── ...
│   └── ...
```

## 3. CloudFront Distribution Setup

```bash
# Create CloudFront Origin Access Identity
aws cloudfront create-cloud-front-origin-access-identity \
  --cloud-front-origin-access-identity-config \
  CallerReference="localmemory-downloads-$(date +%s)",Comment="Local Memory Downloads OAI"

# Note: Save the OAI ID from the response for the next step
```

## 4. Security Configuration

### S3 Bucket Policy (Updated with actual OAI)
Replace `YOUR_OAI_ID` with the actual Origin Access Identity ID:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "CloudFrontAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity YOUR_OAI_ID"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::localmemory-secure-downloads/downloads/*"
    }
  ]
}
```

### Block Public Access
```bash
# Ensure bucket is not publicly accessible
aws s3api put-public-access-block \
  --bucket localmemory-secure-downloads \
  --public-access-block-configuration \
  BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
```

## 5. Next Steps

1. Create the S3 bucket using the commands above
2. Set up CloudFront distribution (next section)
3. Update your main domain's CloudFront to route `/downloads/*` to this bucket
4. Upload test binaries to verify the structure works
5. Test the secure URLs generated by your frontend

## 6. Cost Optimization

- Set up S3 lifecycle policies to delete old time windows (e.g., after 30 days)
- Use S3 Standard-IA for infrequently accessed files
- Enable CloudFront compression for faster downloads